#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "üîí Running security checks..."
echo ""

# ====================================
# CRITICAL SECURITY CHECK
# Prevent .env.local from being committed
# ====================================

# Check if .env.local is being committed
if git diff --cached --name-only | grep -E "^\.env\.local$" > /dev/null 2>&1; then
    echo "‚ùå‚ùå‚ùå CRITICAL ERROR ‚ùå‚ùå‚ùå"
    echo ""
    echo "You are trying to commit .env.local!"
    echo "This file contains sensitive API keys and must NEVER be committed."
    echo ""
    echo "To fix this:"
    echo "  git restore --staged .env.local"
    echo ""
    echo "The file should remain only on your local machine."
    echo ""
    exit 1
fi

# Check if any .env*.local files are being committed
if git diff --cached --name-only | grep -E "\.env.*\.local$" > /dev/null 2>&1; then
    echo "‚ùå‚ùå‚ùå CRITICAL ERROR ‚ùå‚ùå‚ùå"
    echo ""
    echo "You are trying to commit environment files with .local extension!"
    echo "These files contain sensitive credentials and must NEVER be committed."
    echo ""
    echo "Files detected:"
    git diff --cached --name-only | grep -E "\.env.*\.local$"
    echo ""
    echo "To fix this:"
    echo "  git restore --staged <filename>"
    echo ""
    exit 1
fi

# Check if any API keys are in staged files (basic check)
if git diff --cached | grep -E "(ANTHROPIC_API_KEY|STRIPE_SECRET_KEY|FIREBASE_ADMIN_PRIVATE_KEY|sk-ant-|sk_live_|sk_test_)" | grep -v "ANTHROPIC_API_KEY=" | grep -v "#" > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  WARNING: Possible API key detected in staged files"
    echo ""
    echo "Please review your changes to ensure no secrets are being committed."
    echo ""
    echo "If this is a false positive, you can proceed."
    echo "Otherwise, please remove the sensitive data before committing."
    echo ""
    read -p "Do you want to proceed? (yes/no): " response
    if [ "$response" != "yes" ]; then
        echo ""
        echo "Commit aborted."
        exit 1
    fi
fi

echo "‚úÖ Security checks passed - no sensitive files detected"
echo ""
