#!/usr/bin/env sh

echo ""
echo "🔒 Running security checks..."
echo ""

# ====================================
# CRITICAL SECURITY CHECK
# Prevent .env.local from being committed
# ====================================

# Check if .env.local is being committed
if git diff --cached --name-only | grep -E "(^|/)\.env\.local$" > /dev/null 2>&1; then
    echo "❌❌❌ CRITICAL ERROR ❌❌❌"
    echo ""
    echo "You are trying to commit .env.local!"
    echo "This file contains sensitive API keys and must NEVER be committed."
    echo ""
    echo "To fix this:"
    echo "  git restore --staged .env.local"
    echo ""
    echo "The file should remain only on your local machine."
    echo ""
    exit 1
fi

# Check if any .env*.local files are being committed
if git diff --cached --name-only | grep -E "\.env.*\.local$" > /dev/null 2>&1; then
    echo "❌❌❌ CRITICAL ERROR ❌❌❌"
    echo ""
    echo "You are trying to commit environment files with .local extension!"
    echo "These files contain sensitive credentials and must NEVER be committed."
    echo ""
    echo "Files detected:"
    git diff --cached --name-only | grep -E "\.env.*\.local$"
    echo ""
    echo "To fix this:"
    echo "  git restore --staged <filename>"
    echo ""
    exit 1
fi

# Check for actual API key values (not just env var references)
if git diff --cached | grep -E "(sk-ant-[a-zA-Z0-9]{20,}|sk_live_[a-zA-Z0-9]{20,}|sk_test_[a-zA-Z0-9]{20,})" > /dev/null 2>&1; then
    echo "❌❌❌ CRITICAL ERROR ❌❌❌"
    echo ""
    echo "Actual API key values detected in staged files!"
    echo "These appear to be real credentials, not environment variable references."
    echo ""
    echo "Please remove the actual key values before committing."
    echo ""
    exit 1
fi

echo "✅ Security checks passed - no sensitive files detected"
echo ""
