# Vercel Environment Variable Management

## Problem
Vercel environment variables (especially `FIREBASE_ADMIN_PRIVATE_KEY`) get removed automatically when:
1. The key was previously exposed in a git commit
2. Vercel's security scanning detects the exposure
3. Automatic security measures remove the compromised key

## Root Cause
The Firebase Admin private key in `SECURITY_INCIDENT.md` indicates keys were exposed in commit `fb8158a`. Even after rotation, if the new key was generated from the same service account, Vercel may continue flagging it.

## Solution

### 1. Generate Completely New Service Account
**DO NOT reuse the exposed service account**

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Navigate to: Project Settings → Service Accounts
3. **Create a NEW service account** (don't just rotate the key)
   - Click "Create Service Account"
   - Name it: `storyscale-admin-v2` or similar
   - Grant role: "Firebase Admin SDK Administrator Service Agent"
4. Generate private key for this NEW service account
5. Delete the OLD exposed service account entirely

### 2. Format the Private Key Correctly for Vercel
The key must be on a **single line** with `\n` as literal two-character strings:

```
-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhki...[rest of key]...\n-----END PRIVATE KEY-----\n
```

**How to format:**
```bash
# If you have the key file from Firebase:
awk 'NF {sub(/\r/, ""); printf "%s\\n",$0;}' your-key-file.json | pbcopy
```

### 3. Set in Vercel Dashboard
1. Go to [Vercel Dashboard](https://vercel.com/henninghts-projects/storyscale-v10/settings/environment-variables)
2. Add/Update: `FIREBASE_ADMIN_PRIVATE_KEY`
3. Scope: Production, Preview, Development
4. Save and **redeploy**

### 4. Verify Environment Variables Checklist
Ensure ALL these are set in Vercel:

**Firebase:**
- ✅ `FIREBASE_ADMIN_PROJECT_ID`
- ✅ `FIREBASE_ADMIN_CLIENT_EMAIL`
- ✅ `FIREBASE_ADMIN_PRIVATE_KEY` (NEW, never exposed)
- ✅ `NEXT_PUBLIC_FIREBASE_API_KEY`
- ✅ `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN`
- ✅ `NEXT_PUBLIC_FIREBASE_PROJECT_ID`
- ✅ `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET`
- ✅ `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID`
- ✅ `NEXT_PUBLIC_FIREBASE_APP_ID`

**Anthropic:**
- ✅ `ANTHROPIC_API_KEY`

**Stripe:**
- ✅ `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`
- ✅ `STRIPE_SECRET_KEY`
- ✅ `STRIPE_WEBHOOK_SECRET`
- ✅ `STRIPE_PRICE_ID_PRO`
- ✅ `STRIPE_PRICE_ID_ENTERPRISE`

**App:**
- ✅ `NEXT_PUBLIC_APP_URL`

## Prevention
1. **Never commit** `.env.local` files
2. **Always rotate** keys if exposed
3. **Create NEW service accounts** instead of rotating keys on exposed accounts
4. **Monitor Vercel logs** for missing environment variable errors

## Quick Check Command
```bash
# Check if required env vars are referenced in code
grep -r "process.env." app/ lib/ --include="*.ts" --include="*.tsx" | grep -v node_modules | sort -u
```

## Emergency Restore Process
If keys disappear again:
1. Check Vercel deployment logs for security warnings
2. Generate completely NEW service account (not just new key)
3. Update ALL references to the new service account
4. Redeploy immediately

## Notes
- Vercel's security system is intentionally aggressive about removing compromised keys
- This is a GOOD thing - it protects your app
- The solution is to use credentials that were NEVER exposed, not just rotated versions
